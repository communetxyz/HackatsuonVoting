name: Deploy to Holesky Testnet

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      verify:
        description: 'Verify contract on block explorer'
        required: false
        default: 'true'
        type: boolean

jobs:
  deploy-testnet:
    name: Deploy to Holesky
    runs-on: ubuntu-latest
    environment: testnet
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Install dependencies
        run: forge install

      - name: Build contracts
        run: |
          forge clean
          forge build

      - name: Load deployment configuration
        id: config
        run: |
          # Read configuration from holesky-deploy.json
          PRIZE_TOKEN=$(jq -r '.prizeToken' holesky-deploy.json)
          PRIZE_AMOUNT=$(jq -r '.prizeAmount' holesky-deploy.json)

          echo "prize_token=$PRIZE_TOKEN" >> $GITHUB_OUTPUT
          echo "prize_amount=$PRIZE_AMOUNT" >> $GITHUB_OUTPUT

      - name: Deploy HackathonVoting
        id: deploy
        env:
          PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
          HOLESKY_RPC_URL: ${{ secrets.HOLESKY_RPC_URL }}
          PRIZE_TOKEN_ADDRESS: ${{ steps.config.outputs.prize_token }}
          PRIZE_AMOUNT: ${{ steps.config.outputs.prize_amount }}
        run: |
          DEPLOY_OUTPUT=$(forge script script/Deploy.s.sol:DeployScript \
            --rpc-url $HOLESKY_RPC_URL \
            --broadcast \
            --slow \
            -vvvv)

          echo "$DEPLOY_OUTPUT"

          # Extract contract address from deployment output (from Logs section, not traces)
          CONTRACT_ADDRESS=$(echo "$DEPLOY_OUTPUT" | grep "^  HackathonVoting deployed to:" | awk '{print $NF}')

          echo "contract_address=$CONTRACT_ADDRESS" >> $GITHUB_OUTPUT
          echo "Deployed to: $CONTRACT_ADDRESS"

      - name: Verify contract
        if: ${{ github.event.inputs.verify != 'false' }}
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          echo "Verifying contract on Etherscan..."
          sleep 30

          forge verify-contract \
            --chain-id 17000 \
            --compiler-version v0.8.20 \
            --num-of-optimizations 200 \
            --evm-version paris \
            --skip-is-verified-check \
            --watch \
            --constructor-args $(cast abi-encode "constructor(address,uint256)" "${{ steps.config.outputs.prize_token }}" "${{ steps.config.outputs.prize_amount }}") \
            ${{ steps.deploy.outputs.contract_address }} \
            src/HackathonVoting.sol:HackathonVoting \
            --etherscan-api-key $ETHERSCAN_API_KEY

      - name: Fund contract with prize tokens
        env:
          HOLESKY_RPC_URL: ${{ secrets.HOLESKY_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
          PRIZE_TOKEN_ADDRESS: ${{ steps.config.outputs.prize_token }}
          PRIZE_AMOUNT: ${{ steps.config.outputs.prize_amount }}
        run: |
          sleep 10

          # Transfer prize tokens to the contract for prize distribution
          cast send $PRIZE_TOKEN_ADDRESS \
            "transfer(address,uint256)" \
            ${{ steps.deploy.outputs.contract_address }} \
            $PRIZE_AMOUNT \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 5

      - name: Register test projects and vote
        id: test_projects
        env:
          HOLESKY_RPC_URL: ${{ secrets.HOLESKY_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
          TEAM_ADDRESS: "0x86213f1cf0a501857B70Df35c1cb3C2EcF112844"
        run: |
          # Register all 4 projects in a single transaction using registerProjects
          # The 4th project won't receive votes, to verify only top 3 get prizes
          CALLDATA=$(cast calldata \
            "registerProjects(string[],string[],string[],string[],string[],string[],string[],address[])" \
            '["AI-Powered Code Assistant","DeFi Yield Optimizer","Smart Home Energy Manager","Blockchain Gaming Platform"]' \
            '["An intelligent code completion tool using GPT-4 to help developers write better code faster","Automatically find and optimize yield farming strategies across multiple DeFi protocols","IoT-based system that optimizes energy consumption in real-time using ML predictions","Play-to-earn gaming ecosystem built on blockchain technology"]' \
            '["CodeWizards","YieldHunters","EcoTech","GameChain"]' \
            '["AI","Web3","IoT","Gaming"]' \
            '["https://placeholder.com/ai-assistant.png","https://placeholder.com/defi-optimizer.png","https://placeholder.com/smart-home.png","https://placeholder.com/gaming-platform.png"]' \
            '["https://demo.codeassistant.dev","https://demo.yieldhunters.fi","https://demo.ecotechhome.io","https://demo.gamechain.io"]' \
            '["https://github.com/codewizards/ai-assistant","https://github.com/yieldhunters/optimizer","https://github.com/ecotech/energy-manager","https://github.com/gamechain/platform"]' \
            ["$TEAM_ADDRESS","$TEAM_ADDRESS","$TEAM_ADDRESS","$TEAM_ADDRESS"])

          cast send ${{ steps.deploy.outputs.contract_address }} \
            "$CALLDATA" \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 5

          # Vote for project 1 (first vote)
          cast send ${{ steps.deploy.outputs.contract_address }} \
            "vote(uint256)" \
            1 \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 5

          # Vote for project 2 (second vote from same address)
          cast send ${{ steps.deploy.outputs.contract_address }} \
            "vote(uint256)" \
            2 \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 5

          # Create a new random wallet and use it to vote for project 3
          WALLET_OUTPUT=$(cast wallet new)
          VOTER2_ADDRESS=$(echo "$WALLET_OUTPUT" | grep "Address:" | awk '{print $2}')
          VOTER2_KEY=$(echo "$WALLET_OUTPUT" | grep "Private key:" | awk '{print $3}')

          # Fund the new voter with some ETH for gas
          cast send $VOTER2_ADDRESS \
            --value 0.05ether \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 10

          # Vote for project 3 from second voter
          set +e  # Temporarily disable exit on error to capture output
          VOTE_TX=$(cast send ${{ steps.deploy.outputs.contract_address }} \
            "vote(uint256)" \
            3 \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $VOTER2_KEY \
            --json 2>&1)
          VOTE_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          if [ $VOTE_EXIT_CODE -ne 0 ]; then
            echo "âŒ Vote transaction failed with exit code: $VOTE_EXIT_CODE"
            echo "Output: $VOTE_TX"
            exit 1
          fi

          VOTE_TX_HASH=$(echo $VOTE_TX | jq -r '.transactionHash')

          if [ "$VOTE_TX_HASH" == "null" ] || [ -z "$VOTE_TX_HASH" ]; then
            echo "âŒ Failed to get transaction hash from vote response"
            exit 1
          fi

          echo "vote_tx_hash=$VOTE_TX_HASH" >> $GITHUB_OUTPUT

          sleep 5

          # Verify the vote was actually recorded
          PROJECT_3_DATA=$(cast call ${{ steps.deploy.outputs.contract_address }} \
            "projects(uint256)(uint256,string,string,string,string,string,string,string,uint256,address)" \
            3 \
            --rpc-url $HOLESKY_RPC_URL)

          PROJECT_3_VOTES=$(echo "$PROJECT_3_DATA" | sed -n '9p')

          echo "Project 3 vote count: $PROJECT_3_VOTES"
          echo "Full project 3 data:"
          echo "$PROJECT_3_DATA"

          if [ "$PROJECT_3_VOTES" == "0" ]; then
            echo "âŒ Project 3 has 0 votes after voting!"
            exit 1
          fi

          # Also check all projects
          for proj in 1 2 3 4; do
            VOTES=$(cast call ${{ steps.deploy.outputs.contract_address }} \
              "projects(uint256)(uint256,string,string,string,string,string,string,string,uint256,address)" \
              $proj \
              --rpc-url $HOLESKY_RPC_URL | sed -n '9p')
            echo "Project $proj votes: $VOTES"
          done

      - name: Resolve voting and verify prize distribution
        id: resolve_voting
        env:
          HOLESKY_RPC_URL: ${{ secrets.HOLESKY_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
          PRIZE_TOKEN_ADDRESS: ${{ steps.config.outputs.prize_token }}
          TEAM_ADDRESS: "0x86213f1cf0a501857B70Df35c1cb3C2EcF112844"
        run: |
          BALANCE_BEFORE=$(cast call $PRIZE_TOKEN_ADDRESS \
            "balanceOf(address)(uint256)" \
            $TEAM_ADDRESS \
            --rpc-url $HOLESKY_RPC_URL)

          echo "Team balance before resolving: $BALANCE_BEFORE"

          CONTRACT_BALANCE=$(cast call $PRIZE_TOKEN_ADDRESS \
            "balanceOf(address)(uint256)" \
            ${{ steps.deploy.outputs.contract_address }} \
            --rpc-url $HOLESKY_RPC_URL)

          echo "Contract balance before resolving: $CONTRACT_BALANCE"

          RESOLVE_TX=$(cast send ${{ steps.deploy.outputs.contract_address }} \
            "resolveVoting()" \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json)

          RESOLVE_TX_HASH=$(echo $RESOLVE_TX | jq -r '.transactionHash')
          echo "resolve_tx_hash=$RESOLVE_TX_HASH" >> $GITHUB_OUTPUT
          echo "Resolve transaction: $RESOLVE_TX_HASH"

          sleep 5

          BALANCE_AFTER=$(cast call $PRIZE_TOKEN_ADDRESS \
            "balanceOf(address)(uint256)" \
            $TEAM_ADDRESS \
            --rpc-url $HOLESKY_RPC_URL)

          echo "Team balance after resolving: $BALANCE_AFTER"

          CONTRACT_BALANCE_AFTER=$(cast call $PRIZE_TOKEN_ADDRESS \
            "balanceOf(address)(uint256)" \
            ${{ steps.deploy.outputs.contract_address }} \
            --rpc-url $HOLESKY_RPC_URL)

          echo "Contract balance after resolving: $CONTRACT_BALANCE_AFTER"

          # Calculate expected prize (3 / 3 = 1 token per winner, all 3 projects received votes)
          EXPECTED_PRIZE=3
          ACTUAL_PRIZE=$((BALANCE_AFTER - BALANCE_BEFORE))

          echo "Expected prize distribution: $EXPECTED_PRIZE"
          echo "Actual prize distributed: $ACTUAL_PRIZE"

          if [ "$ACTUAL_PRIZE" -eq "$EXPECTED_PRIZE" ]; then
            echo "âœ… Prize distribution verified successfully!"
          else
            echo "âŒ Prize distribution mismatch! Expected: $EXPECTED_PRIZE, Actual: $ACTUAL_PRIZE"
            exit 1
          fi

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Holesky Testnet Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** Holesky (Ethereum Testnet)" >> $GITHUB_STEP_SUMMARY
          echo "**Chain ID:** 17000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Contracts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Contract | Address | Explorer |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| HackathonVoting | \`${{ steps.deploy.outputs.contract_address }}\` | [View on Etherscan](https://holesky.etherscan.io/address/${{ steps.deploy.outputs.contract_address }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Projects Registered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **AI-Powered Code Assistant** (AI) - by CodeWizards (1 vote) ðŸ†" >> $GITHUB_STEP_SUMMARY
          echo "2. **DeFi Yield Optimizer** (Web3) - by YieldHunters (1 vote) ðŸ†" >> $GITHUB_STEP_SUMMARY
          echo "3. **Smart Home Energy Manager** (IoT) - by EcoTech (1 vote) ðŸ†" >> $GITHUB_STEP_SUMMARY
          echo "4. **Blockchain Gaming Platform** (Gaming) - by GameChain (0 votes) âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Vote Transaction:** [\`${{ steps.test_projects.outputs.vote_tx_hash }}\`](https://holesky.etherscan.io/tx/${{ steps.test_projects.outputs.vote_tx_hash }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Resolve Transaction:** [\`${{ steps.resolve_voting.outputs.resolve_tx_hash }}\`](https://holesky.etherscan.io/tx/${{ steps.resolve_voting.outputs.resolve_tx_hash }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Prize Distribution:** âœ… Verified (3 tokens distributed: 1 to each top 3 project, project 4 received 0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Save deployment artifacts
        run: |
          mkdir -p deployments/holesky

          cat > deployments/holesky/deployment.json << EOF
          {
            "network": "holesky",
            "chainId": 17000,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployer": "GitHub Actions",
            "contracts": {
              "HackathonVoting": {
                "address": "${{ steps.deploy.outputs.contract_address }}",
                "explorer": "https://holesky.etherscan.io/address/${{ steps.deploy.outputs.contract_address }}"
              }
            }
          }
          EOF

          cat deployments/holesky/deployment.json

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: holesky-deployment
          path: deployments/holesky/

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const contractAddress = '${{ steps.deploy.outputs.contract_address }}';
            const explorerUrl = `https://holesky.etherscan.io/address/${contractAddress}`;

            const comment = `## ðŸš€ Holesky Testnet Deployment

            **Network:** Holesky (Ethereum Testnet)
            **Chain ID:** 17000

            ### Deployed Contracts

            | Contract | Address | Explorer |
            | --- | --- | --- |
            | HackathonVoting | \`${contractAddress}\` | [View on Etherscan](${explorerUrl}) |

            ### Interact with Contract

            \`\`\`bash
            # Register a project (owner only)
            cast send ${contractAddress} \\
              "registerProject(string,string,string,string,string,string,string,address)" \\
              "Test Project" \\
              "A test project" \\
              "Test Team" \\
              "AI" \\
              "https://image.url" \\
              "https://demo.url" \\
              "https://github.url" \\
              "0xYourTeamAddress" \\
              --rpc-url https://1rpc.io/holesky \\
              --private-key $PRIVATE_KEY

            # Vote for a project
            cast send ${contractAddress} \\
              "vote(uint256)" \\
              1 \\
              --rpc-url https://1rpc.io/holesky \\
              --private-key $PRIVATE_KEY

            # Get voting data
            cast call ${contractAddress} \\
              "getVotingData(address)" \\
              <YOUR_ADDRESS> \\
              --rpc-url https://ethereum-holesky-rpc.publicnode.com
            \`\`\`

            **Deployment Time:** ${new Date().toISOString()}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
