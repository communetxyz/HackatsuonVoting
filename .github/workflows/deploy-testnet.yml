name: Deploy to Holesky Testnet

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      verify:
        description: 'Verify contract on block explorer'
        required: false
        default: 'true'
        type: boolean

jobs:
  deploy-testnet:
    name: Deploy to Holesky
    runs-on: ubuntu-latest
    environment: testnet
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Install dependencies
        run: forge install

      - name: Build contracts
        run: forge build

      - name: Deploy HackathonVoting
        id: deploy
        env:
          PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
          HOLESKY_RPC_URL: ${{ secrets.HOLESKY_RPC_URL }}
          PRIZE_TOKEN_ADDRESS: ${{ secrets.PRIZE_TOKEN_ADDRESS }}
          PRIZE_AMOUNT: ${{ secrets.PRIZE_AMOUNT }}
        run: |
          echo "Deploying HackathonVoting to Holesky testnet..."

          DEPLOY_OUTPUT=$(forge script script/Deploy.s.sol:DeployScript \
            --rpc-url $HOLESKY_RPC_URL \
            --broadcast \
            --slow \
            -vvvv)

          echo "$DEPLOY_OUTPUT"

          # Extract contract address from deployment output (from Logs section, not traces)
          CONTRACT_ADDRESS=$(echo "$DEPLOY_OUTPUT" | grep "^  HackathonVoting deployed to:" | awk '{print $NF}')

          echo "contract_address=$CONTRACT_ADDRESS" >> $GITHUB_OUTPUT
          echo "Deployed to: $CONTRACT_ADDRESS"

      - name: Verify contract
        if: ${{ github.event.inputs.verify != 'false' }}
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          echo "Verifying HackathonVoting contract on Etherscan..."

          forge verify-contract \
            --chain-id 17000 \
            --compiler-version v0.8.20 \
            --watch \
            ${{ steps.deploy.outputs.contract_address }} \
            src/HackathonVoting.sol:HackathonVoting \
            --etherscan-api-key $ETHERSCAN_API_KEY || echo "Verification failed or contract already verified"

      - name: Register test projects and vote
        id: test_projects
        env:
          HOLESKY_RPC_URL: ${{ secrets.HOLESKY_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
        run: |
          echo "Registering 3 mock projects for testing..."

          # Project 1: AI Chatbot
          cast send ${{ steps.deploy.outputs.contract_address }} \
            "registerProject(string,string,string,string,string,string,string,address)" \
            "AI-Powered Code Assistant" \
            "An intelligent code completion tool using GPT-4 to help developers write better code faster" \
            "CodeWizards" \
            "AI" \
            "https://placeholder.com/ai-assistant.png" \
            "https://demo.codeassistant.dev" \
            "https://github.com/codewizards/ai-assistant" \
            "0x1111111111111111111111111111111111111111" \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 5

          # Project 2: Web3 DeFi
          cast send ${{ steps.deploy.outputs.contract_address }} \
            "registerProject(string,string,string,string,string,string,string,address)" \
            "DeFi Yield Optimizer" \
            "Automatically find and optimize yield farming strategies across multiple DeFi protocols" \
            "YieldHunters" \
            "Web3" \
            "https://placeholder.com/defi-optimizer.png" \
            "https://demo.yieldhunters.fi" \
            "https://github.com/yieldhunters/optimizer" \
            "0x2222222222222222222222222222222222222222" \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 5

          # Project 3: IoT Smart Home
          cast send ${{ steps.deploy.outputs.contract_address }} \
            "registerProject(string,string,string,string,string,string,string,address)" \
            "Smart Home Energy Manager" \
            "IoT-based system that optimizes energy consumption in real-time using ML predictions" \
            "EcoTech" \
            "IoT" \
            "https://placeholder.com/smart-home.png" \
            "https://demo.ecotechhome.io" \
            "https://github.com/ecotech/energy-manager" \
            "0x3333333333333333333333333333333333333333" \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json > /dev/null

          sleep 5

          # Verify project count
          PROJECT_COUNT=$(cast call ${{ steps.deploy.outputs.contract_address }} \
            "projectCount()(uint256)" \
            --rpc-url $HOLESKY_RPC_URL)

          echo "Total projects registered: $PROJECT_COUNT"

          # Cast a test vote for project 1
          VOTE_TX=$(cast send ${{ steps.deploy.outputs.contract_address }} \
            "vote(uint256)" \
            1 \
            --rpc-url $HOLESKY_RPC_URL \
            --private-key $PRIVATE_KEY \
            --json)

          VOTE_TX_HASH=$(echo $VOTE_TX | jq -r '.transactionHash')
          echo "vote_tx_hash=$VOTE_TX_HASH" >> $GITHUB_OUTPUT
          echo "Test vote cast: $VOTE_TX_HASH"

          sleep 5

          # Get total votes to verify
          TOTAL_VOTES=$(cast call ${{ steps.deploy.outputs.contract_address }} \
            "getTotalVotes()(uint256)" \
            --rpc-url $HOLESKY_RPC_URL)

          echo "Total votes: $TOTAL_VOTES"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Holesky Testnet Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** Holesky (Ethereum Testnet)" >> $GITHUB_STEP_SUMMARY
          echo "**Chain ID:** 17000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Contracts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Contract | Address | Explorer |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| HackathonVoting | \`${{ steps.deploy.outputs.contract_address }}\` | [View on Etherscan](https://holesky.etherscan.io/address/${{ steps.deploy.outputs.contract_address }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Projects Registered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **AI-Powered Code Assistant** (AI) - by CodeWizards" >> $GITHUB_STEP_SUMMARY
          echo "2. **DeFi Yield Optimizer** (Web3) - by YieldHunters" >> $GITHUB_STEP_SUMMARY
          echo "3. **Smart Home Energy Manager** (IoT) - by EcoTech" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Vote" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Vote Transaction: [\`${{ steps.test_projects.outputs.vote_tx_hash }}\`](https://holesky.etherscan.io/tx/${{ steps.test_projects.outputs.vote_tx_hash }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Save deployment artifacts
        run: |
          mkdir -p deployments/holesky

          cat > deployments/holesky/deployment.json << EOF
          {
            "network": "holesky",
            "chainId": 17000,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployer": "GitHub Actions",
            "contracts": {
              "HackathonVoting": {
                "address": "${{ steps.deploy.outputs.contract_address }}",
                "explorer": "https://holesky.etherscan.io/address/${{ steps.deploy.outputs.contract_address }}"
              }
            }
          }
          EOF

          cat deployments/holesky/deployment.json

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: holesky-deployment
          path: deployments/holesky/

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const contractAddress = '${{ steps.deploy.outputs.contract_address }}';
            const explorerUrl = `https://holesky.etherscan.io/address/${contractAddress}`;

            const comment = `## ðŸš€ Holesky Testnet Deployment

            **Network:** Holesky (Ethereum Testnet)
            **Chain ID:** 17000

            ### Deployed Contracts

            | Contract | Address | Explorer |
            | --- | --- | --- |
            | HackathonVoting | \`${contractAddress}\` | [View on Etherscan](${explorerUrl}) |

            ### Interact with Contract

            \`\`\`bash
            # Register a project (owner only)
            cast send ${contractAddress} \\
              "registerProject(string,string,string,string,string,string,string,address)" \\
              "Test Project" \\
              "A test project" \\
              "Test Team" \\
              "AI" \\
              "https://image.url" \\
              "https://demo.url" \\
              "https://github.url" \\
              "0xYourTeamAddress" \\
              --rpc-url https://1rpc.io/holesky \\
              --private-key $PRIVATE_KEY

            # Vote for a project
            cast send ${contractAddress} \\
              "vote(uint256)" \\
              1 \\
              --rpc-url https://1rpc.io/holesky \\
              --private-key $PRIVATE_KEY

            # Get voting data
            cast call ${contractAddress} \\
              "getVotingData(address)" \\
              <YOUR_ADDRESS> \\
              --rpc-url https://ethereum-holesky-rpc.publicnode.com
            \`\`\`

            **Deployment Time:** ${new Date().toISOString()}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
